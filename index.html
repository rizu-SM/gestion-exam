<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affectation Examens</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        button {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 18px;
            border-radius: 5px;
            margin: 5px 0;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 300px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .close {
            float: right;
            cursor: pointer;
            font-size: 20px;
        }

        select, input {
            width: 100%;
            padding: 8px;
            margin: 5px 0 15px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .semester-selection {
            margin-bottom: 20px;
        }

        .exam-table {
            margin-top: 20px;
            width: 100%;
            border-collapse: collapse;
        }

        .exam-table th, .exam-table td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .exam-table th {
            background-color: #f2f2f2;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        select:disabled {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    
    <ul id="formationsList" style="display: none;"> </ul>
    <!-- Semestre Selection -->
    <div class="semester-selection">
        <label for="semester">Choisir un semestre :</label>
        <select id="semester">
            <option value="s1">Semestre 1</option>
            <option value="s2">Semestre 2</option>
            <option value="r1">Rattrapage 1</option>
            <option value="r2">Rattrapage 2</option>
        </select>
    </div>

    <!-- Button to Open Modal -->
    <button id="openModalBtn">Ajouter un examen</button>

    <!-- Modal for Adding Exam -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Affecter un Examen</h2>

            <label for="palier">Palier :</label>
            <select id="palier">
                <option value="">Sélectionner</option> <!-- Option vide par défaut -->
            </select>

            <label for="specialite">Spécialité :</label>
            <select id="specialite" disabled>
                <option value="">Sélectionner un palier d'abord</option>
            </select>


            <label for="module">Module :</label>
            <select id="module" disabled>
                <option value="">Sélectionner</option>
            </select>

            
            <label for="section">Section :</label>
            <input type="text" id="section" placeholder="Ex: B">

            <label for="date">Date :</label>
            <input type="date" id="date">

            <label for="heure">Heure :</label>
            <input type="time" id="heure">

            <label for="salle">Salle :</label>
            <input type="text" id="salle" placeholder="Ex: A12">

            <button id="ajouter">Ajouter</button>
        </div>
    </div>

    <!-- Exam Table -->
    <table id="examTable" class="exam-table">
        <thead>
            <tr>
                <th>Semestre</th>
                <th>Palier</th>
                <th>Spécialité</th>
                <th>Module</th>
                <th>Section</th>
                <th>Date</th>
                <th>Heure</th>
                <th>Salle</th>
            </tr>
        </thead>
        <tbody>
            <!-- Les données des examens ajoutés seront affichées ici -->
        </tbody>
    </table>










    
    <script>

        let formationsData = [];  // Variable globale pour stocker les formations

        window.onload = function() {
        fetch('http://localhost:3000/envoyer-formation')
            .then(response => response.json())
            .then(data => {
                console.log(data);
                formationsData = data;

                // Afficher les paliers
                const palierSelect = document.getElementById('palier');
                const paliers = new Set(data.map(formation => formation.palier));

                palierSelect.innerHTML = '<option value="">Sélectionner</option>';
                paliers.forEach(palier => {
                    const option = new Option(palier, palier);
                    palierSelect.add(option);
                });

                // Gérer le changement de palier
                palierSelect.addEventListener('change', function() {
                    const selectedPalier = this.value;
                    const specialiteSelect = document.getElementById('specialite');
                    
                    specialiteSelect.innerHTML = '<option value="">Sélectionner</option>';
                    specialiteSelect.disabled = true;

                    if (selectedPalier) {
                        const specialites = new Set(
                            formationsData
                                .filter(formation => formation.palier === selectedPalier)
                                .map(formation => formation.specialite)
                        );

                        specialites.forEach(specialite => {
                            const option = new Option(specialite, specialite);
                            specialiteSelect.add(option);
                        });

                        specialiteSelect.disabled = false;
                    }
                });

                // Gérer le changement de spécialité
                document.getElementById('specialite').addEventListener('change', function() {
                    const selectedPalier = document.getElementById('palier').value;
                    const selectedSpecialite = this.value;
                    const selectedSession = document.getElementById('semester').value;
                    const moduleSelect = document.getElementById('module');
                    
                    moduleSelect.innerHTML = '<option value="">Sélectionner</option>';
                    moduleSelect.disabled = true;

                    if (selectedPalier && selectedSpecialite) {
                        // Déterminer le groupe de session
                        const sessionGroup = selectedSession.startsWith('s') 
                            ? ['S1', 'R1'] 
                            : ['S2', 'R2'];

                        // Filtrer les modules
                        const modules = new Set(
                            formationsData
                                .filter(formation => 
                                    formation.palier === selectedPalier &&
                                    formation.specialite === selectedSpecialite &&
                                    sessionGroup.includes(formation.session)
                                )
                                .map(formation => formation.module)
                        );

                        // Remplir les modules
                        modules.forEach(module => {
                            const option = new Option(module, module);
                            moduleSelect.add(option);
                        });

                        moduleSelect.disabled = modules.size === 0;
                    }
                });

                // Gérer le changement de session
                document.getElementById('semester').addEventListener('change', function() {
                    // Si une spécialité est déjà sélectionnée, rafraîchir les modules
                    if (document.getElementById('specialite').value) {
                        document.getElementById('specialite').dispatchEvent(new Event('change'));
                    }
                });
            })
            .catch(error => {
                console.error('Erreur:', error);
            });
    };

    document.addEventListener("DOMContentLoaded", function() {
        const modal = document.getElementById("modal");
        const openModalBtn = document.getElementById("openModalBtn");
        const closeModal = document.querySelector(".close");

        // Ouvrir la modale
        openModalBtn.onclick = function() {
            modal.style.display = "flex";
        };

        // Fermer la modale
        closeModal.onclick = function() {
            modal.style.display = "none";
        };

        // Ajouter un examen
        document.getElementById("ajouter").onclick = function() {
            const semestre = document.getElementById("semester").value;
            const palier = document.getElementById("palier").value;
            const specialite = document.getElementById("specialite").value;
            const module = document.getElementById("module").value;
            const section = document.getElementById("section").value;
            const date = document.getElementById("date").value;
            const heure = document.getElementById("heure").value;
            const salle = document.getElementById("salle").value;

            if (!palier || !specialite || !module || !date || !heure || !salle || !semestre) {
                alert('Veuillez remplir tous les champs obligatoires.');
                return;
            }

            fetch('http://localhost:3000/ajouter-examen', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    palier,
                    specialite,
                    section,
                    module,
                    date,
                    heure,
                    salle,
                    semestre
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Ajouter à la table
                    const tbody = document.getElementById("examTable").getElementsByTagName("tbody")[0];
                    const newRow = tbody.insertRow();
                    newRow.insertCell(0).textContent = semestre;
                    newRow.insertCell(1).textContent = palier;
                    newRow.insertCell(2).textContent = specialite;
                    newRow.insertCell(3).textContent = module;
                    newRow.insertCell(4).textContent = section;
                    newRow.insertCell(5).textContent = date;
                    newRow.insertCell(6).textContent = heure;
                    newRow.insertCell(7).textContent = salle;

                    // Réinitialiser le formulaire
                    modal.style.display = "none";
                    document.getElementById("date").value = "";
                    document.getElementById("heure").value = "";
                    document.getElementById("salle").value = "";
                    document.getElementById("palier").value = "";
                    document.getElementById("specialite").innerHTML = "<option value=''>Sélectionner</option>";
                    document.getElementById("module").innerHTML = "<option value=''>Sélectionner</option>";
                    document.getElementById("specialite").disabled = true;
                    document.getElementById("module").disabled = true;
                    document.getElementById("section").value = "";
                } else {
                    alert(data.message || "Erreur lors de l'ajout");
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert("Erreur lors de l'envoi des données");
            });
        };
    });





    

        document.addEventListener("DOMContentLoaded", function () {
            const modal = document.getElementById("modal");
            const openModalBtn = document.getElementById("openModalBtn");
            const closeModal = document.querySelector(".close");
            const palierSelect = document.getElementById("palier");
            const specialiteSelect = document.getElementById("specialite");
            const moduleSelect = document.getElementById("module");
            const sectionSelect = document.getElementById("section");
            const semesterSelect = document.getElementById("semester");

    
            let addedExams = [];
    
            // Ouvrir la modale
            openModalBtn.onclick = function () {
                modal.style.display = "flex";
            };
    
            // Fermer la modale
            closeModal.onclick = function () {
                modal.style.display = "none";
            };
    
            // Mettre à jour les spécialités
            palierSelect.onchange = function () {
                specialiteSelect.innerHTML = "<option value=''>Sélectionner</option>";
                moduleSelect.innerHTML = "<option value=''>Sélectionner</option>";
                specialiteSelect.disabled = true;
                moduleSelect.disabled = true;
    
                if (palierSelect.value) {
                    specialites[palierSelect.value].forEach(specialite => {
                        let option = new Option(specialite, specialite);
                        specialiteSelect.appendChild(option);
                    });
                    specialiteSelect.disabled = false;
                }
            };
    
            // Mettre à jour les modules
            specialiteSelect.onchange = function () {
                moduleSelect.innerHTML = "<option value=''>Sélectionner</option>";
                moduleSelect.disabled = true;
    
                if (specialiteSelect.value) {
                    modulesParSpecialite[specialiteSelect.value].forEach(module => {
                        let option = new Option(module, module);
                        moduleSelect.appendChild(option);
                    });
                    moduleSelect.disabled = false;
                }
            };
    
            // Ajouter un examen
            document.getElementById("ajouter").onclick = function () {
                const semestre = semesterSelect.value;
                const palier = palierSelect.value;
                const specialite = specialiteSelect.value;
                const module = moduleSelect.value;
                const section = sectionSelect.value;
                const date = document.getElementById("date").value;
                const heure = document.getElementById("heure").value;
                const salle = document.getElementById("salle").value;
    
                if (!palier || !specialite || !module || !date || !heure || !salle || !semestre) {
                    alert('Veuillez remplir tous les champs obligatoires.');
                    return;
                }
    
                // Envoyer les données au backend
                fetch('http://localhost:3000/ajouter-examen', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        palier,
                        specialite,
                        section,
                        module,
                        date,
                        heure,
                        salle,
                        semestre
                    })
                })
                .then(response => {
                    if (!response.ok) throw new Error("Erreur réseau");
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        
                        // Ajouter la ligne dans le tableau
                        const tbody = document.getElementById("examTable").getElementsByTagName("tbody")[0];
                        const newRow = tbody.insertRow();
                        newRow.insertCell(0).textContent = semestre;
                        newRow.insertCell(1).textContent = palier;
                        newRow.insertCell(2).textContent = specialite;
                        newRow.insertCell(3).textContent = module;
                        newRow.insertCell(4).textContent = section;
                        newRow.insertCell(5).textContent = date;
                        newRow.insertCell(6).textContent = heure;
                        newRow.insertCell(7).textContent = salle;

                        // Fermer la modale et réinitialiser les champs
                        modal.style.display = "none";
                        document.getElementById("date").value = "";
                        document.getElementById("heure").value = "";
                        document.getElementById("salle").value = "";
                        palierSelect.value = "";
                        specialiteSelect.innerHTML = "<option value=''>Sélectionner</option>";
                        moduleSelect.innerHTML = "<option value=''>Sélectionner</option>";
                        specialiteSelect.disabled = true;
                        moduleSelect.disabled = true;
                        sectionSelect.value = "";
                    } else {
                        alert(data.message || "Une erreur est survenue.");
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert("Erreur lors de l'envoi des données.");
                });
            };
        });

    </script>
</body>
</html>
